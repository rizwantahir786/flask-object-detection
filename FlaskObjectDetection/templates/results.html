<!DOCTYPE html>
<html>

<head>
  <title>Object Detection System</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"> -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="static/css/results.css">
</head>

<body>
  <div class="header shadow sticky-top">
    <p class="text-center header_text">Object Detection System</p>
    <nav class="nav_home">
      <ul>
        <li><button class="btn nav_btn" onclick="location.href='/';">Home</button></li>
        <li><button class="btn nav_btn active" onclick="location.href='/results';">Results</button></li>
      </ul>
    </nav>
  </div>
  <div class="container  ">
    <div class="margin_top100 padding_bottom100">
      <table class="table table-striped table-responsive-md shadow text-center">
        <thead>
          <tr>
            <!-- <th>ID</th> -->
            <th>Image Name</th>
            <th>Non-classified Image</th>
            <th>Classified Image</th>
            <th>Detected Objects</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Table rows will be generated by JavaScript -->
        </tbody>
      </table>
      <ul class="pagination justify-content-center " id="pagination">
        <!-- Pagination links will be generated by JavaScript -->
      </ul>

    </div>

  </div>
  <script>

    // Data array 

    let dataString = "{{all_results}}"
    let root_path = "{{root_path}}"
    let data = JSON.parse(dataString.replace(/&#39;/g, '"'));
    console.log(data);
    // Constants
    const rowsPerPage = 2;
    const numPagesToShow = 5;

    // Variables
    let currentPage = 1;
    let totalPages = Math.ceil(data.length / rowsPerPage);
    let startPage = 1;
    let endPage = Math.min(totalPages, numPagesToShow);
    generateTableRows();
    generatePaginationLinks();
    // Functions
    function generateTableRows() {
      let tableBody = document.getElementById('table-body');
      tableBody.innerHTML = '';

      let startIndex = (currentPage - 1) * rowsPerPage;
      let endIndex = Math.min(startIndex + rowsPerPage, data.length);

      for (let i = startIndex; i < endIndex; i++) {
        let row = `
      <tr>
        <td>${data[i].image_name}</td>
        <td><img src=${root_path + data[i].non_classified_image} height="300" width="300" /></td>
        <td><img src=${root_path + data[i].classified_image} height="300" width="300" /></td>
        <td>${data[i].objects_detected}</td>
    <td><button class="btn btn-primary btn-block" onclick="openModal(${i})">View Details</button></td>
      </tr>
    `;
        tableBody.innerHTML += row;
      }
    }

    function generatePaginationLinks() {
      let pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      let startPageButton = `
    <li class="page-item ${currentPage == 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">&laquo;</a>
    </li>
  `;
      pagination.innerHTML += startPageButton;

      for (let i = startPage; i <= endPage; i++) {
        let pageButton = `
      <li class="page-item ${currentPage == i ? 'active' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
      </li>
    `;
        pagination.innerHTML += pageButton;
      }

      let endPageButton = `
    <li class="page-item ${currentPage == totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">&raquo;</a>
    </li>
  `;
      pagination.innerHTML += endPageButton;
    }
    function goToPage(page) {
      if (page < 1 || page > totalPages) {
        return;
      }
      currentPage = page;
      startPage = currentPage - Math.floor(numPagesToShow / 2);
      endPage = startPage + numPagesToShow - 1;
      if (startPage < 1) {
        startPage = 1;
        endPage = Math.min(totalPages, numPagesToShow);
      }
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = endPage - Math.max(numPagesToShow - 1, 1);
      }
      generateTableRows();
      generatePaginationLinks();
    }

    function openModal(index) {
      let modal = document.createElement('div');
      modal.classList.add('modal');
      modal.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detected Image Details</h5>
          <button type="button" class="btn btn-close btn-danger" data-bs-dismiss="modal">X</button>
        </div>
        <div class="modal-body">
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Objects Detected: ${data[index].objects_detected}</strong>
          </div>
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Non-classified Image</strong> 
          </div>
          <center>
            <img src=${root_path + data[index].non_classified_image} height="300" width="300" />
          </center>
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Classified Image</strong> 
          </div>
          <center>
            <img src=${root_path + data[index].classified_image} height="300" width="300" />
          </center>
          <table class="table margin_top20">
            <thead>
              <tr>
                <th>Class</th>
                <th>Accuracy</th>
              </tr>
            </thead>
            <tbody>
              ${data[index].class_and_associated_probabilities.map((probability, index) => `
                <tr>
                  <td>${probability.class}</td>
                  <td>${probability.accuracy}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="modal-footer ">
        </div>
      </div>
    </div>
  `;
      document.body.appendChild(modal);
      let modalElement = new bootstrap.Modal(modal);
      modalElement.show();

      let closeButton = modal.querySelector('.btn-close');
      closeButton.addEventListener('click', () => {
        modalElement.hide();
        modal.remove();
      });
    }
  </script>


</body>

</html>