<!-- html 5 -->
<!DOCTYPE html>
<html>

<head>
  <!-- To set the title of the page -->
  <title>Object Detection System</title>
  <!-- To set the character encoding to utf-8 -->
  <meta charset="utf-8">
  <!-- To set the viewport for the page to the width of the device and initial zoom level to 1 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- To load the Open Sans font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
  <!--  To load the jQuery library from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- To load the Bootstrap CSS framework from a CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
  <!-- To load the Bootstrap JS library from a CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
  <!-- To load the custom stylesheet for the page from static directory -->
  <link rel="stylesheet" type="text/css" href="static/css/results.css">
</head>

<body>
  <!-- Header for the page -->
  <div class="header shadow sticky-top">
    <p class="text-center header_text">Object Detection System</p>
    <!-- Navigation bar with two buttons: Home and Results (to display all the results from firebase database) -->
    <nav class="nav_home">
      <ul>
        <li><button class="btn nav_btn " onclick="location.href='/';">Home</button></li>
        <li><button class="btn nav_btn active" onclick="location.href='/results';">Results</button></li>
      </ul>
    </nav>
  </div>
  <!-- Container having html table to display all the results saved in firebase -->
  <div class="container  ">
    <div class="margin_top100 padding_bottom100">
      <table class="table table-striped table-responsive-md shadow text-center">
        <thead>
          <tr>
            <th>Image Name</th>
            <th>Non-classified Image</th>
            <th>Classified Image</th>
            <th>Detected Objects</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Table rows will be generated by JavaScript -->
        </tbody>
      </table>
      <div id="error-message"></div>

      <ul class="pagination justify-content-center " id="pagination">
        <!-- Pagination links will be generated by JavaScript -->
      </ul>

    </div>

  </div>
  <script>

    // Data array 

    let dataString = "{{all_results}}"
    let root_path = "{{root_path}}"
    let data = JSON.parse(dataString.replace(/&#39;/g, '"'));
    console.log(data);
    // Constants
    const rowsPerPage = 2;
    const numPagesToShow = 5;

    // Variables
    let currentPage = 1;
    let totalPages = Math.ceil(data.length / rowsPerPage);
    let startPage = 1;
    let endPage = Math.min(totalPages, numPagesToShow);
    generateTableRows();
    generatePaginationLinks();

    let error = "{{error}}" // declare a variable "error" and assign it the value of the "error" template variable,
    if (error) { // check if "error" is truthy
        var errorMessage = document.getElementById("error-message"); // declare a variable "errorMessage" and assign it the HTML element with the ID "error-message"
        errorMessage.innerHTML = error; // set the HTML content of the "errorMessage" element to the value of the "error" variable
        errorMessage.style.display = "block"; // set the "display" CSS property of the "errorMessage" element to "block"
    }


    // ############################### Functions ################################

    // This function generates the rows of the table based on the current page and number of rows 
    function generateTableRows() {
      let tableBody = document.getElementById('table-body');
      tableBody.innerHTML = '';

      let startIndex = (currentPage - 1) * rowsPerPage;
      let endIndex = Math.min(startIndex + rowsPerPage, data.length);
      // Loop through the data and generate a table row for each item in the current page range
      for (let i = startIndex; i < endIndex; i++) {
        let row = `
      <tr>
        <td>${data[i].image_name}</td>
        <td><img src=${root_path + data[i].non_classified_image} height="300" width="300" /></td>
        <td><img src=${root_path + data[i].classified_image} height="300" width="300" /></td>
        <td>${data[i].objects_detected}</td>
    <td><button class="btn btn-primary btn-block" onclick="openModal(${i})">View Details</button></td>
      </tr>
    `;
        // Add the generated row to the table body
        tableBody.innerHTML += row;
      }
    }

    function generatePaginationLinks() {
      // Get the pagination element and reset its content
      let pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      // Create the "previous page" button
      let startPageButton = `
    <li class="page-item ${currentPage == 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">&laquo;</a>
    </li>
  `;
      pagination.innerHTML += startPageButton;

      // Create a button for each page number to display in the pagination
      for (let i = startPage; i <= endPage; i++) {
        let pageButton = `
      <li class="page-item ${currentPage == i ? 'active' : ''}">
        <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
      </li>
    `;
        pagination.innerHTML += pageButton;
      }

      // Create the "next page" button
      let endPageButton = `
    <li class="page-item ${currentPage == totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">&raquo;</a>
    </li>
  `;
      pagination.innerHTML += endPageButton;
    }

    function goToPage(page) {
      // Check if page number is valid
      if (page < 1 || page > totalPages) {
        return;
      }
      // Set current page number
      currentPage = page;
      // Calculate start and end page numbers for pagination links
      startPage = currentPage - Math.floor(numPagesToShow / 2);
      endPage = startPage + numPagesToShow - 1;
      // Handle case when start page is less than 1
      if (startPage < 1) {
        startPage = 1;
        endPage = Math.min(totalPages, numPagesToShow);
      }
      // Handle case when end page is greater than total number of pages
      if (endPage > totalPages) {
        endPage = totalPages;
        startPage = endPage - Math.max(numPagesToShow - 1, 1);
      }
      // Regenerate table rows and pagination links
      generateTableRows();
      generatePaginationLinks();
    }

    function openModal(index) {
      // create a new div element for the modal
      let modal = document.createElement('div');
      // add a 'modal' class to the modal div
      modal.classList.add('modal');
      // set the HTML content of the modal div using a template literal
      modal.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detected Image Details</h5>
          <button type="button" class="btn btn-close btn-danger" data-bs-dismiss="modal">X</button>
        </div>
        <div class="modal-body">
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Objects Detected: ${data[index].objects_detected}</strong>
          </div>
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Non-classified Image</strong> 
          </div>
          <center>
            <img src=${root_path + data[index].non_classified_image} height="300" width="300" />
          </center>
          <div class="modal_body_heading">
            <strong class="modal_body_heading_font">Classified Image</strong> 
          </div>
          <center>
            <img src=${root_path + data[index].classified_image} height="300" width="300" />
          </center>
          <table class="table margin_top20">
            <thead>
              <tr>
                <th>Class</th>
                <th>Accuracy</th>
              </tr>
            </thead>
            <tbody>
              ${data[index].class_and_associated_probabilities.map((probability, index) => `
                <tr>
                  <td>${probability.class}</td>
                  <td>${probability.accuracy}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="modal-footer ">
        </div>
      </div>
    </div>
  `;
      // append the modal div to the document body
      document.body.appendChild(modal);
      // create a new Bootstrap modal object
      let modalElement = new bootstrap.Modal(modal);
      // show the modal
      modalElement.show();

      // get a reference to the close button inside the modal
      let closeButton = modal.querySelector('.btn-close');
      // add an event listener for when the close button is clicked
      closeButton.addEventListener('click', () => {
        // hide the modal
        modalElement.hide();
        // remove the modal from the DOM
        modal.remove();
      });
    }
  </script>


</body>

</html>